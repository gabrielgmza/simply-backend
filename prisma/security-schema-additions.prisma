// ============================================
// SECURITY SCHEMA ADDITIONS
// Add these models to your prisma/schema.prisma
// Simply Backend v3.8.0
// ============================================

/*
  Copiar estas definiciones al final de tu schema.prisma existente.
  Luego ejecutar: npx prisma migrate dev --name security_phase1_2
*/

// ====================
// TRUST SCORE
// ====================

model trust_scores {
  id                   String   @id @default(uuid())
  user_id              String
  score                Int      // 0-1000
  tier                 String   // CRITICAL, LOW, MEDIUM, HIGH, ELITE
  identity_score       Int      // 0-200
  financial_score      Int      // 0-200
  behavioral_score     Int      // 0-200
  transactional_score  Int      // 0-200
  social_score         Int      // 0-200
  calculated_at        DateTime @default(now())

  user users @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([calculated_at])
  @@index([tier])
}

// ====================
// RISK ASSESSMENTS
// ====================

model risk_assessments {
  id                  String    @id @default(uuid())
  user_id             String
  session_id          String
  operation           String
  risk_score          Int       // 0-100
  risk_level          String    // MINIMAL, LOW, MEDIUM, HIGH, CRITICAL
  required_action     String    // ALLOW, BIOMETRY, OTP, 2FA, STEP_UP, COOLDOWN, BLOCK
  risk_factors        Json
  ip_address          String
  device_fingerprint  String?
  amount              Decimal?  @db.Decimal(18, 2)
  challenge_completed Boolean   @default(false)
  completed_at        DateTime?
  created_at          DateTime  @default(now())

  user users @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([session_id])
  @@index([created_at])
  @@index([risk_level])
}

// ====================
// USER DEVICES
// ====================

model user_devices {
  id                String    @id @default(uuid())
  user_id           String
  fingerprint       String
  platform          String    // ios, android, web, unknown
  os_version        String?
  device_model      String?
  app_version       String?
  screen_resolution String?
  timezone          String?
  language          String?
  trust_level       String    @default("NEW") // NEW, KNOWN, TRUSTED, UNTRUSTED
  first_seen_at     DateTime  @default(now())
  last_seen_at      DateTime  @default(now())
  last_ip           String?
  login_count       Int       @default(0)
  successful_ops    Int       @default(0)
  failed_ops        Int       @default(0)
  is_blocked        Boolean   @default(false)
  blocked_reason    String?
  blocked_at        DateTime?
  trusted_at        DateTime?
  is_emulator       Boolean   @default(false)
  is_rooted         Boolean   @default(false)
  metadata          Json?

  user users @relation(fields: [user_id], references: [id])

  @@unique([user_id, fingerprint])
  @@index([user_id])
  @@index([fingerprint])
  @@index([trust_level])
}

// ====================
// USER SESSIONS (Extended)
// ====================

model user_sessions {
  id                  String    @id @default(uuid())
  user_id             String
  device_fingerprint  String?
  ip_address          String
  user_agent          String?
  geo_location        Json?     // {lat, lng, country, city}
  is_valid            Boolean   @default(true)
  invalidated_reason  String?
  created_at          DateTime  @default(now())
  ended_at            DateTime?

  user users @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([device_fingerprint])
  @@index([created_at])
}

// ====================
// IP BLACKLIST
// ====================

model ip_blacklist {
  ip_address  String   @id
  reason      String
  source      String   // manual, automatic, external
  added_by    String?
  added_at    DateTime @default(now())
  expires_at  DateTime?

  @@index([expires_at])
}

// ====================
// FLAGGED ACCOUNTS
// ====================

model flagged_accounts {
  id          String   @id @default(uuid())
  cvu         String   @unique
  reason      String
  risk_level  String   // LOW, MEDIUM, HIGH, CRITICAL
  source      String   // internal, external, regulatory
  flagged_at  DateTime @default(now())
  flagged_by  String?
  expires_at  DateTime?

  @@index([risk_level])
}

// ====================
// EMPLOYEE ANOMALIES
// ====================

model employee_anomalies {
  id                String    @id @default(uuid())
  employee_id       String
  anomaly_type      String
  severity          String    // LOW, MEDIUM, HIGH, CRITICAL
  description       String
  details           Json
  baseline          Json?
  actual            Json?
  deviation_percent Float?
  ip_address        String
  user_agent        String?
  session_id        String?
  status            String    @default("DETECTED") // DETECTED, INVESTIGATING, FALSE_POSITIVE, CONFIRMED, RESOLVED
  actions_taken     Json?
  detected_at       DateTime  @default(now())
  resolved_at       DateTime?
  resolved_by       String?

  employee employees @relation(fields: [employee_id], references: [id])

  @@index([employee_id])
  @@index([anomaly_type])
  @@index([severity])
  @@index([status])
  @@index([detected_at])
}

// ====================
// EMPLOYEE BASELINES
// ====================

model employee_baselines {
  employee_id            String   @id
  normal_work_hours      Json     // {start: 9, end: 18}
  normal_work_days       Json     // [1,2,3,4,5]
  avg_daily_actions      Float    @default(0)
  avg_daily_data_access  Float    @default(0)
  avg_daily_approvals    Float    @default(0)
  avg_daily_exports      Float    @default(0)
  assigned_client_ids    Json?    // ["uuid1", "uuid2"]
  avg_clients_accessed   Float    @default(0)
  known_ips              Json?    // ["ip1", "ip2"]
  updated_at             DateTime @default(now())

  employee employees @relation(fields: [employee_id], references: [id])
}

// ====================
// EMPLOYEE SESSIONS
// ====================

model employee_sessions {
  id                 String    @id @default(uuid())
  employee_id        String
  ip_address         String
  user_agent         String?
  device_fingerprint String?
  is_valid           Boolean   @default(true)
  invalidated_reason String?
  created_at         DateTime  @default(now())
  ended_at           DateTime?

  employee employees @relation(fields: [employee_id], references: [id])

  @@index([employee_id])
  @@index([created_at])
}

// ====================
// USER BEHAVIOR PROFILES
// ====================

model user_behavior_profiles {
  user_id          String   @id
  temporal         Json     // {preferredHours, preferredDays, avgSessionDuration, ...}
  transactional    Json     // {avgTransactionAmount, frequentRecipients, ...}
  navigation       Json     // {mostVisitedScreens, featureAdoptionRate, ...}
  device           Json     // {primaryPlatform, deviceCount, ...}
  risk_indicators  Json     // {unusualActivityScore, accountStabilityScore, ...}
  segment          String   // POWER_USER, REGULAR, PASSIVE, DORMANT, NEW_USER, HIGH_VALUE, AT_RISK
  profile_version  Int      @default(1)
  data_points      Int      @default(0)
  updated_at       DateTime @default(now())

  user users @relation(fields: [user_id], references: [id])

  @@index([segment])
  @@index([updated_at])
}

// ====================
// USER ANALYTICS EVENTS
// ====================

model user_analytics_events {
  id          String   @id @default(uuid())
  user_id     String
  event_type  String   // screen_view, feature_used, search, button_click, etc
  event_data  Json?
  created_at  DateTime @default(now())

  user users @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([event_type])
  @@index([created_at])
}

// ====================
// FRAUD EVALUATIONS
// ====================

model fraud_evaluations {
  id                  String   @id @default(uuid())
  user_id             String
  transaction_id      String?
  fraud_score         Int      // 0-100
  risk_level          String   // MINIMAL, LOW, MEDIUM, HIGH, CRITICAL
  confidence          Int      // 0-100
  decision            String   // APPROVE, APPROVE_WITH_2FA, REVIEW, HOLD, DECLINE, BLOCK_USER
  decision_reason     String
  risk_factors        Json
  positive_factors    Json
  model_version       String
  model_scores        Json     // {isolationForest, neuralNetwork, rulesEngine, ...}
  recommendations     Json     // ["recommendation1", ...]
  context             Json
  processing_time_ms  Int
  evaluated_at        DateTime @default(now())

  user users @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([transaction_id])
  @@index([fraud_score])
  @@index([decision])
  @@index([evaluated_at])
}

// ====================
// SECURITY ALERTS
// ====================

model security_alerts {
  id                  String    @id @default(uuid())
  type                String    // NEW_LOGIN, NEW_DEVICE, SUSPICIOUS_ACTIVITY, etc
  priority            String    // LOW, MEDIUM, HIGH, CRITICAL, EMERGENCY
  target_type         String    // USER, EMPLOYEE, SYSTEM, COMPLIANCE
  target_id           String?
  title               String
  message             String
  data                Json?
  channels            Json      // ["PUSH", "EMAIL", ...]
  delivery_status     Json      // {PUSH: {sent: true, ...}, ...}
  source_service      String
  related_entity_type String?
  related_entity_id   String?
  escalation_level    Int       @default(0)
  next_escalation_at  DateTime?
  acknowledged_at     DateTime?
  acknowledged_by     String?
  resolved_at         DateTime?
  resolved_by         String?
  resolution          String?
  created_at          DateTime  @default(now())

  @@index([type])
  @@index([priority])
  @@index([target_type, target_id])
  @@index([created_at])
  @@index([resolved_at])
}

// ====================
// ALERT WEBHOOKS
// ====================

model alert_webhooks {
  id          String   @id @default(uuid())
  name        String
  url         String
  secret      String
  alert_types Json     // ["FRAUD_SPIKE", "KILL_SWITCH_ACTIVATED", ...]
  enabled     Boolean  @default(true)
  created_by  String
  created_at  DateTime @default(now())

  @@index([enabled])
}

// ====================
// SYSTEM SETTINGS
// ====================

model system_settings {
  key         String   @id
  value       Json
  description String?
  category    String?  // security, compliance, general, etc
  updated_by  String?
  updated_at  DateTime @default(now())

  @@index([category])
}

// ====================
// UPDATES TO EXISTING MODELS
// ====================

// Add to 'users' model:
// trust_scores      trust_scores[]
// risk_assessments  risk_assessments[]
// user_devices      user_devices[]
// user_sessions     user_sessions[]
// behavior_profile  user_behavior_profiles?
// analytics_events  user_analytics_events[]
// fraud_evaluations fraud_evaluations[]

// Add to 'employees' model:
// anomalies          employee_anomalies[]
// baseline           employee_baselines?
// sessions           employee_sessions[]
// requires_dual_approval Boolean @default(false)
// dual_approval_reason   String?
